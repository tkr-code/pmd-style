{% import "macros/table.html.twig" as table %}
{% import "macros/head.html.twig" as head %}
{% import "macros/foot.html.twig" as foot %}
{% import "macros/button.html.twig" as btn %}
{% import "macros/link.html.twig" as link %}
{% import "macros/dataTable.html.twig" as dataTable %}
{% import "macros/breadcrumb.html.twig" as breadcrumb %}

{% extends 'admin/base.html.twig' %}

{% block title %}Ma clé d'API
{% endblock %}
{% block breadcrumb %}
	{{ breadcrumb.breadcrumb('Ma clé d\'API')}}
{% endblock %}
{% block body %}
	{% include "includes/_alerte.html.twig" %}
	<div class="card card-outline card-primary">
		<div class="card-header"></div>
		<div class="card-body">
			<a id="btn-edit-api" data-token="{{ csrf_token('edit_api' ~ app.user.id) }}" class="btn btn-primary my-1" href="#">Generer une nouvelle clé</a>
			<hr>
			<div>
				<h3>Ma clé d'Api</h3>
			</div>
			<dl>
                <div class="loader-edit-apiKey">
                  <div class="overlay"><i class="fas fa-2x fa-sync-alt fa-spin"></i></div>
                </div>
				<dd id="apiKey" class="bg-light p-2 rounded">{{ app.user.apiKey }}</dd>
			</dl>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
<script>
$(document).ready(function(){
    $('.loader-edit-apiKey').css('display', 'none')
    // Generer une cle d'api 
    $(document).on('click', '#btn-edit-api', function () {
        let token = $(this).data('token')
      Swal.fire({
        title: 'Etes vous sûr?',
        text: "Vous etes sur le point de génerer une nouvelle clé api ! ",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        cancelButtonText: 'Fermer',
        confirmButtonText: 'Oui, je confirme!'
      }).then((result) => {
        if (result.isConfirmed) {
        //   ajax
          $.ajax({
            url: "/my-account/profile-edit-api-key",
            method: "POST",
            dataType: 'json',
            data: {
                _token: token,
            },
            beforeSend: function () {
              $('.loader-edit-apiKey').css('display', 'initial')
              $('#btn-edit-email, #apiKey').css('display', 'none')
            },
            success: function (data) {
                console.log(data)
              if(data.response == true){
                $('#apiKey').text(data.content)
                  Swal.fire({
                  icon: 'success',
                  title: 'Opération reussie !',
                  showConfirmButton: false,
                  timer: 1500
                })
              }else{
                Swal.fire({
                  icon: 'warning',
                  title: 'Une erreur est servenue !',
                  showConfirmButton: false,
                  timer: 1500
                })
              }
              $('.loader-edit-apiKey, #apiKey').css('display', 'none')
              $('#apiKey').css('display', 'initial')
            }
          })
          //  ./ajax end
        }
      })
    })
})
</script>
{% endblock %}
